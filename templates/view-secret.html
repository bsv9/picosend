<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicoSend - View Secret</title>
    <meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#131e1f" media="(prefers-color-scheme: dark)">

    <!-- Open Graph meta tags for chat messengers and social media -->
    <meta property="og:title" content="Secure Secret - PicoSend">
    <meta property="og:description" content="Someone shared a secure secret with you. This message will be deleted after you read it once.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{.RequestURL}}">
    <meta property="og:site_name" content="PicoSend">
    <meta property="og:image" content="{{.BaseURL}}/static/og-image.png">
    <meta property="og:image:alt" content="PicoSend - Secure Secret Sharing">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Secure Secret - PicoSend">
    <meta name="twitter:description" content="Someone shared a secure secret with you. This message will be deleted after you read it once.">
    <meta name="twitter:image" content="{{.BaseURL}}/static/og-image.png">
    <meta name="twitter:image:alt" content="PicoSend - Secure Secret Sharing">

    <!-- Additional meta tags for better SEO and sharing -->
    <meta name="description" content="View a securely shared secret. One-time access only - the message will be permanently deleted after viewing.">
    <meta name="robots" content="noindex, nofollow">

    <link href="/static/css/pico.min.css" rel="stylesheet">
    <style>
        header.hero { text-align: center; padding: 1rem 0 0; }
        header.hero h1 { margin-bottom: 0.25rem; }
        header.hero p { margin-bottom: 0; }
        pre.secret-content {
            white-space: pre-wrap;
            word-break: break-all;
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-size: 1.1rem;
            border: 2px solid var(--pico-primary);
            border-radius: var(--pico-border-radius);
        }
        footer.site-footer { text-align: center; margin-top: 2rem; opacity: 0.6; }

        /* Pico-style alerts */
        .alert {
            margin-bottom: var(--pico-spacing);
            padding: var(--pico-form-element-spacing-vertical) var(--pico-form-element-spacing-horizontal);
            border-radius: var(--pico-border-radius);
            color: var(--alert-color);
            background-color: var(--alert-bg);
            border: 1px solid var(--alert-border);
            background-image: var(--alert-icon);
            background-position: center left var(--pico-form-element-spacing-vertical);
            background-size: 1.5em auto;
            background-repeat: no-repeat;
            padding-left: calc(var(--pico-form-element-spacing-vertical) * 2 + 1.5em);
        }
        .alert-warning {
            --alert-bg: #fff8e1;
            --alert-border: #ffe082;
            --alert-color: #e65100;
            --alert-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23e65100' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='12' y1='8' x2='12' y2='12'%3E%3C/line%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'%3E%3C/line%3E%3C/svg%3E");
        }
        .alert-danger {
            --alert-bg: #ffebee;
            --alert-border: #ef9a9a;
            --alert-color: #b71c1c;
            --alert-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23b71c1c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='15' y1='9' x2='9' y2='15'%3E%3C/line%3E%3Cline x1='9' y1='9' x2='15' y2='15'%3E%3C/line%3E%3C/svg%3E");
        }
        .alert-success {
            --alert-bg: #e8f5e9;
            --alert-border: #a5d6a7;
            --alert-color: #1b5e20;
            --alert-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%231b5e20' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 11.08V12a10 10 0 1 1-5.93-9.14'%3E%3C/path%3E%3Cpolyline points='22 4 12 14.01 9 11.01'%3E%3C/polylyline%3E%3C/svg%3E");
        }
        @media (prefers-color-scheme: dark) {
            .alert-warning {
                --alert-bg: rgba(255, 248, 225, 0.08);
                --alert-border: rgba(255, 224, 130, 0.25);
                --alert-color: #ffb74d;
                --alert-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23ffb74d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='12' y1='8' x2='12' y2='12'%3E%3C/line%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'%3E%3C/line%3E%3C/svg%3E");
            }
            .alert-danger {
                --alert-bg: rgba(255, 235, 238, 0.08);
                --alert-border: rgba(239, 154, 154, 0.25);
                --alert-color: #ef9a9a;
                --alert-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23ef9a9a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='15' y1='9' x2='9' y2='15'%3E%3C/line%3E%3Cline x1='9' y1='9' x2='15' y2='15'%3E%3C/line%3E%3C/svg%3E");
            }
            .alert-success {
                --alert-bg: rgba(232, 245, 233, 0.08);
                --alert-border: rgba(165, 214, 167, 0.25);
                --alert-color: #a5d6a7;
                --alert-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a5d6a7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 11.08V12a10 10 0 1 1-5.93-9.14'%3E%3C/path%3E%3Cpolyline points='22 4 12 14.01 9 11.01'%3E%3C/polylyline%3E%3C/svg%3E");
            }
        }
    </style>
</head>
<body>
    <main class="container">
        <header class="hero">
            <h1><a href="/" style="text-decoration: none; color: inherit;">PicoSend</a></h1>
            <p><small>Share secrets securely. Once read, they're gone forever.</small></p>
        </header>

        <section>
            <article id="initialView">
                <div class="alert alert-warning" role="alert">This secret will be permanently deleted after viewing.</div>
                <button id="revealBtn" class="contrast" style="width: 100%;">Reveal Secret</button>
            </article>

            <article id="secretView" style="display: none;">
                <pre id="secretContent" class="secret-content"></pre>
                <button id="copySecretBtn" type="button" class="secondary outline" style="width: 100%;">Copy</button>
                <div class="alert alert-danger" role="alert">This secret has been permanently deleted. <small id="secretTimestamp"></small></div>
            </article>

            <article id="errorView" style="display: none;">
                <div class="alert alert-danger" role="alert">This secret doesn't exist or has already been viewed.</div>
                <a href="/" role="button" class="secondary outline" style="width: 100%;">Create a New Secret</a>
            </article>

            <article id="loadingView" style="display: none;">
                <p aria-busy="true" style="text-align: center;">Loading...</p>
            </article>
        </section>

        <footer class="site-footer">
            <p><small><a href="https://github.com/bsv9/picosend" target="_blank" class="secondary">GitHub</a></small></p>
        </footer>
    </main>

    <script>
        function generateVerificationCode() {
            // Generate random 6-character alphanumeric code
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Decrypt function for client-side decryption
        async function decryptData(encryptedBase64, keyBase64) {
            // Convert base64 key to bytes
            const keyBytes = Uint8Array.from(atob(keyBase64), (c) => c.charCodeAt(0));

            // Import the key
            const cryptoKey = await crypto.subtle.importKey("raw", keyBytes, { name: "AES-CBC" }, false, ["decrypt"]);

            // Convert base64 encrypted data to bytes
            const combined = Uint8Array.from(atob(encryptedBase64), (c) => c.charCodeAt(0));

            // Extract IV (first 16 bytes)
            const iv = combined.slice(0, 16);
            const encrypted = combined.slice(16);

            // Decrypt the data
            const decrypted = await crypto.subtle.decrypt({ name: "AES-CBC", iv: iv }, cryptoKey, encrypted);

            // Decode to string
            const decoder = new TextDecoder();
            return decoder.decode(decrypted);
        }

        document.getElementById('revealBtn').addEventListener('click', async function() {
            // Extract encryption key from URL hash fragment
            const keyFromHash = window.location.hash.substring(1); // Remove the '#'
            if (!keyFromHash) {
                alert('Invalid secret link: decryption key is missing from URL');
                return;
            }

            const secretId = window.location.pathname.split('/').filter(Boolean).pop();
            const verificationCode = generateVerificationCode();

            // Show loading state
            document.getElementById('initialView').style.display = 'none';
            document.getElementById('loadingView').style.display = 'block';

            try {
                const response = await fetch('/api/secrets/' + secretId + '/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        verification_code: verificationCode
                    })
                });

                if (response.ok) {
                    const data = await response.json();

                    // Decrypt the content locally using the key from URL hash
                    try {
                        const decryptedContent = await decryptData(data.content, keyFromHash);

                        document.getElementById('secretContent').textContent = decryptedContent;
                        document.getElementById('secretTimestamp').textContent = 'Created: ' + data.created_at;

                        // Store the content for copying
                        window.secretContentForCopy = decryptedContent;

                        document.getElementById('loadingView').style.display = 'none';
                        document.getElementById('secretView').style.display = 'block';
                    } catch (decryptError) {
                        console.error('Decryption error:', decryptError);
                        document.getElementById('loadingView').style.display = 'none';
                        document.getElementById('errorView').querySelector('.alert').textContent = 'Unable to decrypt the secret. The link may be corrupted or incomplete.';
                        document.getElementById('errorView').style.display = 'block';
                    }
                } else {
                    // Secret not found or other error
                    document.getElementById('loadingView').style.display = 'none';
                    document.getElementById('errorView').style.display = 'block';
                }
            } catch (error) {
                // Show error
                console.error('Fetch error:', error);
                document.getElementById('loadingView').style.display = 'none';
                document.getElementById('errorView').style.display = 'block';
            }
        });

        // Copy secret button functionality
        document.addEventListener('click', function(e) {
            if (e.target.id === 'copySecretBtn') {
                if (window.secretContentForCopy) {
                    navigator.clipboard.writeText(window.secretContentForCopy).then(function() {
                        const btn = document.getElementById('copySecretBtn');
                        const originalText = btn.textContent;
                        btn.textContent = 'Copied!';
                        setTimeout(() => {
                            btn.textContent = originalText;
                        }, 2000);
                    }).catch(function() {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = window.secretContentForCopy;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);

                        const btn = document.getElementById('copySecretBtn');
                        const originalText = btn.textContent;
                        btn.textContent = 'Copied!';
                        setTimeout(() => {
                            btn.textContent = originalText;
                        }, 2000);
                    });
                }
            }
        });
    </script>
</body>
</html>
